<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>changed-stream</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="changed-stream"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-12-17 08:26:33 MST"/>
<meta name="author" content="Warren Wilkinson"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">changed-stream</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Overview</a>
<ul>
<li><a href="#sec-1-1">1.1 Features</a></li>
<li><a href="#sec-1-2">1.2 Limitations</a></li>
</ul>
</li>
<li><a href="#sec-2">2 Installation</a>
<ul>
<li><a href="#sec-2-1">2.1 Quick Lisp</a></li>
<li><a href="#sec-2-2">2.2 Gentoo</a></li>
<li><a href="#sec-2-3">2.3 Ubunto</a></li>
<li><a href="#sec-2-4">2.4 Manual Installation</a></li>
<li><a href="#sec-2-5">2.5 Running the Tests</a></li>
<li><a href="#sec-2-6">2.6 Getting Support</a></li>
</ul>
</li>
<li><a href="#sec-3">3 Implementation</a>
<ul>
<li><a href="#sec-3-1">3.1 diffcase</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1 changed-stream class</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2 file-position</a></li>
<li><a href="#sec-3-3">3.3 read-char</a></li>
<li><a href="#sec-3-4">3.4 peek-char</a></li>
<li><a href="#sec-3-5">3.5 read-sequence</a></li>
<li><a href="#sec-3-6">3.6 Test Framework</a>
<ul>
<li><a href="#sec-3-6-1">3.6.1 Read Patterns</a></li>
<li><a href="#sec-3-6-2">3.6.2 Running Tests</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-4">4 Tests</a>
<ul>
<li><a href="#sec-4-1">4.1 Deletion Tests</a></li>
<li><a href="#sec-4-2">4.2 Insertion Tests</a></li>
<li><a href="#sec-4-3">4.3 Replacement Tests</a></li>
<li><a href="#sec-4-4">4.4 Replace+Delete Tests</a></li>
<li><a href="#sec-4-5">4.5 Replace+Insert Tests</a></li>
</ul>
</li>
<li><a href="#sec-5">5 License</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">


<p>
Changed-stream lets you apply changes to a stream, without modifying the underlying stream.
In this example, stream s remains unmodified except for file-position<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>. 
</p>



<pre class="example">  (with-input-from-string (s "0123456789")
    (let ((d (change-stream s
                :at 3
                :delete 1
                :insert "xyz")))
      (read-line d)))
;; "012xyz456789"
</pre>


<p>
&hellip;and changed-streams are composable, but be aware of the order of operations. 
</p>




<pre class="example">(with-input-from-string
  (s "The Cat in the Hat")
  (read-line (change-stream 
              (change-stream s
                 :at 2
                 :delete 6)
              :at 12
              :insert "chery")))
;; "Thin the Hatchery"
</pre>




<pre class="example">(with-input-from-string
  (s "The Cat in the Hat")
  (read-line (change-stream 
              (change-stream s
                 :at 12
                 :insert "chery")
              :at 2
              :delete 6)))
;; "Thin tcheryhe Hat"
</pre>




</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Features</h3>
<div class="outline-text-3" id="text-1-1">


<ul>
<li>read-char
</li>
<li>peek-char
</li>
<li>file-position
</li>
<li>read-sequence has been efficiently implemented.
</li>
<li>extending and shrinking the stream (deleting or inserting near the end will shrink and grow the stream).
</li>
</ul>


</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Limitations</h3>
<div class="outline-text-3" id="text-1-2">


<ul>
<li>The underlying stream must be at file-position 0 when the changed-stream is created. There is an assert to catch this.
</li>
<li>Thread safety is your responsibility &ndash; in particular don't change the file-position of the underlying stream, the changed-stream will give incorrect results and could cause errors.
</li>
<li>unread-char has not been implemented (but peek-char has been)
</li>
<li>Read only. There are no writing operations allowed to the stream
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Installation</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Quick Lisp</h3>
<div class="outline-text-3" id="text-2-1">


<p>
Install <a href="http://www.quicklisp.org/beta/">Quick Lisp</a> and then run:
</p>



<pre class="example">(ql:quickload 'changed-stream)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section, and you may want to <a href="#runtests">run the tests</a>.
</p>
</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Gentoo</h3>
<div class="outline-text-3" id="text-2-2">


<p>
As root, 
</p>



<pre class="example">emerge changed-stream
</pre>


<p>
Once the emerge is finished, the package can be loaded using ASDF:
</p>


<pre class="example">(asdf:operate 'asdf:load-op :changed-stream)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section, otherwise you may want to <a href="#runtests">run the tests</a>.
</p>
</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Ubunto</h3>
<div class="outline-text-3" id="text-2-3">





<pre class="example">sudo apt-get install changed-stream
</pre>


<p>
Once the installation is finished, the package is loadable using ASDF:
</p>



<pre class="example">(asdf:operate 'asdf:load-op :changed-stream)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section, otherwise you may want to <a href="#runtests">run the tests</a>.
</p>
</div>

</div>

<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Manual Installation</h3>
<div class="outline-text-3" id="text-2-4">


<p>
In summary: Untar the <a href="https://github.com/WarrenWilkinson/changed-stream/archive/master.tar.gz">.tar</a> package and then symlink the .asd files into a place where ASDF can find them. 
</p>
<ol>
<li>Untar the files where you want them to be.  On windows download the <a href="https://github.com/WarrenWilkinson/changed-stream/archive/master.zip">.zip</a> and unzip it instead, it's the same files.
</li>
<li>ASDF could be looking anywhere &ndash; it depends on your setup.  Run this in your lisp repl to get a clue
     as to where ASDF is seeking libraries<sup><a class="footref" name="fnr.2" href="#fn.2">2</a></sup>:




<pre class="example">(mapcan #'funcall asdf:*default-source-registries*)
</pre>


</li>
<li>Symlink the .asd files to the source directory. If you use windows, <a href="http://bc.tech.coop/blog/041113.html">these instructions on symlink alternatives apply to you</a>.
</li>
</ol>


<p>
Once the files are in place, the package can be loaded with ASDF by:
</p>


<pre class="example">(asdf:operate 'asdf:load-op :changed-stream)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section.  If you don't have problems you may want to <a href="#runtests">run the tests</a> anyway, because you can.
</p>
</div>

</div>

<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> Running the Tests</h3>
<div class="outline-text-3" id="text-2-5">


<p>
Once the system is loaded, it can be tested with asdf. 
</p>



<pre class="example">(asdf:operate 'asdf:test-op :changed-stream)
</pre>


<p>
This should display something like the following. There should
be <b>zero failures</b>, if you have failures see the <a href="#support">support</a> section
of this document.
</p>



<pre class="example">RUNNING CHANGED-STREAM TESTS...
CHANGED-STREAM TEST RESULTS: 
     Tests: 124
   Success: 124
  Failures: 0
</pre>


</div>

</div>

<div id="outline-container-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> Getting Support</h3>
<div class="outline-text-3" id="text-2-6">


<p>
You can find support on this libraries <a href="http://warrenwilkinson.ca/changed-stream">website</a> and/or <a href="https://github.com/WarrenWilkinson/changed-stream">github</a> repository. Or you can email <a href="mailto:warrenwilkinson@gmail.com">Warren Wilkinson</a>.
</p>
</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Implementation</h2>
<div class="outline-text-2" id="text-3">


<p>
A changed stream has five zones:
</p>
<dl>
<dt>1. Before</dt><dd>The area before our changes.
</dd>
<dt>2. Replace</dt><dd>The range were our changes overwrite the source.
</dd>
<dt>3. Delete</dt><dd>The range where we are deleting (not emitting) source characters.
</dd>
<dt>4. Insert</dt><dd>The range where we are outputing new characters, but not consuming source characters.
</dd>
<dt>5. After</dt><dd>The area after our changes. 
</dd>
</dl>


<p>
We never have both delete and insert, instead we'd represent that as a replace and insert or a replace and delete.
</p>

</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> diffcase</h3>
<div class="outline-text-3" id="text-3-1">


<p>
The changed-stream class is designed to support a macro called 'diffcase'. This macro is like a case statement,
but supports these five parts.  Most of the stream functions use this macro.
</p>



<pre class="example">(defmacro diffcase ((position stream)
                    (before &amp;rest before-case-code)
                    (replace &amp;rest replace-case-code)
                    (delete &amp;rest delete-case-code)
                    (insert &amp;rest insert-case-code)
                    (after &amp;rest after-case-code))
  (declare (ignore before replace delete insert after))
  (let ((pos (gensym)) (strm (gensym)))
    `(let ((,pos ,position) (,strm ,stream))
       (cond ((&lt; ,pos (last-unchanged-position ,strm)) ,@before-case-code)
             ((&lt; ,pos (last-replacement-position ,strm)) ,@replace-case-code)
             ((&lt; ,pos (last-modified-position ,strm))
              (if (mod-is-delete-p ,strm)
                  (progn ,@delete-case-code)
                  (progn ,@insert-case-code)))
             (t ,@after-case-code)))))
</pre>



</div>

<div id="outline-container-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> changed-stream class</h4>
<div class="outline-text-4" id="text-3-1-1">


<p>
The class support the macros, and the macro cares about character positions: At what position is the
first change?  At what position is the last replacement?  And where is the last modification!
</p>
<p>
The class stores these precomputed values so we don't have to add our change-position to the minimum of 
the length of the insert string vs the number of deleted characters &ndash; we know this number,
it's 'last-replacement-position'.
</p>



<pre class="example">(defclass changed-stream (fundamental-character-input-stream)
  ((stream                    :initarg  :stream                    
                              :reader stream-of)
   (virtual-position          :initform 0
                              :accessor virtual-position)
   (last-unchanged-position   :initarg  :last-unchanged-position  
                              :reader last-unchanged-position)
   (last-replacement-position :initarg  :last-replacement-position 
                              :reader last-replacement-position)
   (last-modified-position    :initarg  :last-modified-position    
                              :reader last-modified-position)
   (removed-characters        :initarg  :removed-characters        
                              :reader removed-characters)
   (insert-string             :initarg  :string  
                              :reader insert-string)))

(defun mod-is-delete-p (stream) (&gt; (removed-characters stream) 0))

(defun change-stream (stream &amp;key (at 0) (insert "") (delete 0))
  (assert (zerop (file-position stream)))
  (let ((last-replace (+ at (min (length insert) delete)))
        (last-mod (+ at (max delete (length insert)))))
    (make-instance 'changed-stream
       :stream stream
       :last-unchanged-position at
       :last-replacement-position last-replace
       :last-modified-position last-mod
       :removed-characters (- delete (length insert)) 
       :string insert)))
</pre>


</div>
</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> file-position</h3>
<div class="outline-text-3" id="text-3-2">


<p>
When we set our own file-position, we have to compute the correct file-position to set the source stream too.
This is easy during the before and replacement stages &ndash; it's our current position.
</p>
<p>
If we are repositioning into the delete range, the file-position of the source moved ahead by the number of characters
to delete.
</p>
<p>
If we are repositioning into the insert range, the file position of the source is just after the position of the last replaced character.
When we start reading the source again, all the replaced characters will have been skipped. 
</p>
<p>
If we are repositioning after the modification range, the file-position of the source moved ahead by the number of characters
to delete. This takes into account the fact that these characters have been skipped and we are further in our source than
we'd be otherwise. If our modification was insert+replace, then removed-characters will be negative and will put the file-position
backwards. Since extra characters have been emitted, we're further back in the source stream.
</p>



<pre class="example">(defmethod stream-file-position ((stream changed-stream) &amp;optional newval)
  (if newval 
      (progn 
        (diffcase (newval stream)
           (before  (file-position (stream-of stream) newval))
           (replace (file-position (stream-of stream) newval))
           (delete  (file-position (stream-of stream)
                                   (+ newval (removed-characters stream))))
           (insert  (file-position (stream-of stream)
                                   (last-replacement-position stream)))
           (after   (file-position (stream-of stream)
                                   (+ newval (removed-characters stream)))))
        (setf (virtual-position stream) newval))
      (virtual-position stream)))
</pre>


</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> read-char</h3>
<div class="outline-text-3" id="text-3-3">


<p>
Real characters are characters from the source stream.  Replacement characters skip a source stream character and 
return the next character from the insert stream (a virtual character).
</p>
<p>
For deletes, we seek the end of the deleted characters and then emit the next.
</p>



<pre class="example">(defmethod stream-read-char ((stream changed-stream))
  (diffcase ((if (mod-is-delete-p stream)
                 (file-position (stream-of stream))
                 (virtual-position stream)) 
             stream)
     (before  (real-char stream))
     (replace (replacement-char stream))
     (delete  (internal-seek-end-of-delete stream) (real-char stream))
     (insert (virtual-char stream))
     (after  (real-char stream))))
</pre>


</div>

</div>

<div id="outline-container-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> peek-char</h3>
<div class="outline-text-3" id="text-3-4">


<p>
Similar in structure <a href="#read-char">read-char</a>, peek-char does the same operation but with peeks.  The replace region just takes
the next virtual-char (rather than the replacement-char which would read and drop the next character from the source stream).
</p>



<pre class="example">(defmethod stream-peek-char ((stream changed-stream))
    (diffcase ((if (mod-is-delete-p stream)
                   (file-position (stream-of stream))
                   (virtual-position stream)) stream)
      (before  (peek-char nil (stream-of stream) nil :eof))
      (replace (virtual-char stream t))
      (delete  (internal-seek-end-of-delete stream) 
               (peek-char nil (stream-of stream) nil :eof))
      (insert  (virtual-char stream t))
      (after   (peek-char nil (stream-of stream) nil :eof))))
</pre>


</div>

</div>

<div id="outline-container-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> read-sequence</h3>
<div class="outline-text-3" id="text-3-5">


<p>
Read sequence is three functions, implemented as one for simplicity. But essentially:
</p>
<ol>
<li>Read the sequence before the changes by calling read-sequence on the source stream. 
</li>
<li>Read the sequence during the changes by call-next-method (which will do it by calls to read-char)
</li>
<li>Read the sequence after the changes by calling read-sequence on the source stream.
</li>
</ol>


<p>
The complexity of this function comes from computing the correct start and end ranges for
these three steps.
</p>



<pre class="example">(defmethod stream-read-sequence ((stream changed-stream) seq &amp;optional start end)
  (let ((position (virtual-position stream)))
    (let ((write-length (- (or end (length seq)) (or start 0))))
      (let ((before-length (min write-length
                            (max 0 (- (last-unchanged-position stream) position)))))
        (read-sequence seq (stream-of stream)
                       :start start
                       :end (+ start before-length))
        (incf start before-length)
        (incf position before-length)
        (decf write-length before-length)
        (file-position stream position))

      (let ((during-length (min write-length 
                            (max 0 (- (last-modified-position stream) position)))))
        (call-next-method stream seq start (+ start during-length))
        (incf start during-length)
        (incf position during-length)
        (decf write-length during-length))

      (let ((after-length write-length))
        (read-sequence seq (stream-of stream)
                       :start start
                       :end (+ start after-length))
        (incf start after-length)
        (incf position after-length)
        (decf write-length after-length)
        (file-position stream position)))))

</pre>


</div>

</div>

<div id="outline-container-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Test Framework</h3>
<div class="outline-text-3" id="text-3-6">


<p>
Tests are just functions, that are pushed onto a list when defined.  Within do-testing are functions that
read and verify the changed-stream using some pattern of reads, peeks, file-positions and read-sequences.
</p>



<pre class="example">(defvar *all-tests* nil)
</pre>



<pre class="example">(defun do-testing (at delete insert is)
  (with-input-from-string (input "0123456789ABCDEF")
    (let ((diff (change-stream input :at at :insert insert :delete delete)))
      (and (pattern-sequential diff is)
           (pattern-sequential+peek diff is)
           (pattern-file-position-forward diff is)
           (pattern-file-position-backward diff is)
           (pattern-file-position-backward-with-reads diff is)
           (pattern-read-sequences diff is)))))

(defmacro deftest (name &amp;key (at 0) (delete 0) (insert "") is)
  `(progn 
     (defun ,name () (do-testing ,at ,delete ,insert ,is))
     (pushnew ',name *all-tests*)))
</pre>



</div>

<div id="outline-container-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> Read Patterns</h4>
<div class="outline-text-4" id="text-3-6-1">



<p>
All the various pattern reading tests use defpattern to wrap a few common variables. It's basically a fixture.
</p>
<ul>
<li>Output the pattern readers name.
</li>
<li>Set file position to 0
</li>
<li>Create a local variable called 'success'
</li>
<li>Create a local variable called 'storage' that can be read into.
</li>
</ul>


<p>
Meanwhile, the macro problem combines outputting an error message, and setting success to false into one operation.
</p>



<pre class="example">(defmacro defpattern (name (diff expected) &amp;rest code)
  `(defun ,name (,diff ,expected)
     (format t ,(concatenate 'string "~% " (string-downcase (symbol-name name))))
     (file-position ,diff 0)
     (let ((success t)
           (storage (make-string (length ,expected) :initial-element #\_)))
       ,@code (format t "~%") success)))

(defmacro problem (msg &amp;rest args)
  `(progn
     (setf success nil)
     (format t ,(concatenate 'string "~%    * " msg)
             ,@args)))
</pre>


<ul>
<li id="sec-3-6-1-1">pattern-sequential<br/>

<p>
Uses read-char to read the entire thing.  Checks to ensure that you are not allowed to read more characters than
should actually exist (called 'overreading' here).
</p>



<pre class="example">(defpattern pattern-sequential (s expected)
  (dotimes (i (length expected))
    (unless (eq i (file-position s)) 
      (problem "Bad file-position, got ~a instead of ~d" 
               (file-position s) i))
    (let ((char (read-char s nil :eof)))
      (if (eq char :eof)
          (problem "EOF at ~d" i)
          (setf (char storage i) char))))
  (let ((char (read-char s nil :eof)))
    (unless (eq char :eof) (problem "Allowed overread of ~a" char)))
  (unless (string= storage expected)
    (problem "Wrong result (got ~s instead of ~s)" storage expected)))

</pre>


</li>
</ul>
<ul>
<li id="sec-3-6-1-2">pattern-sequential+peek<br/>

<p>
Like pattern-sequential, but peeks characters before reading to ensure that peeking doesn't mess things up.
</p>



<pre class="example">
(defpattern pattern-sequential+peek (s expected)
  (dotimes (i (length expected))
    (unless (eq i (file-position s)) 
      (problem "Bad file-position, got ~a instead of ~d"
               (file-position s) i))
    (let* ((peek (peek-char nil s nil :eof))
           (char (read-char s nil :eof)))
      (unless (eq peek char)
        (problem "Peek return ~a, char return ~a at ~a" peek char i))
      (if (eq char :eof)
          (problem "Peek caused EOF character at ~d" i)
          (setf (char storage i) char))))
  (let ((peek (peek-char nil s nil :eof))
        (char (read-char s nil :eof)))
    (unless (eq peek char)
      (problem "Peek overread ~a and char overread ~a." peek char))
    (unless (eq char :eof) 
      (problem "Peek allowed overread of ~a" char))
    (unless (string= storage expected)
      (problem "Wrong result (got ~s instead of ~s)"
               storage expected))))

</pre>


</li>
</ul>
<ul>
<li id="sec-3-6-1-3">pattern-file-position-forward<br/>

<p>
Like pattern-sequential, but does a file-position before each read.  This test is to ensure that file-positions, followed
by reads, always produce the correct result.
</p>



<pre class="example">(defpattern pattern-file-position-forward (s expected)
  (dotimes (i (length expected))
    (file-position s i)
    (let ((char (read-char s nil :eof)))
      (if (eq char :eof)
          (problem "~%EOF at ~2d" i)
          (setf (char storage i) char))))

  (unless (string= storage expected)
    (problem "Wrong result (got ~s instead of ~s)"
             storage expected)))
</pre>


</li>
</ul>
<ul>
<li id="sec-3-6-1-4">pattern-file-position-backward<br/>

<p>
Like pattern-file-position-forward, but in reverse. We read the last character, then the last-1 character&hellip; This
test is because pattern-file-position-forward isn't difficult enough to be a good test of the file-position operation
 on it's own.
</p>



<pre class="example">(defpattern pattern-file-position-backward (s expected)
  (loop for i from (1- (length expected)) downto 0
        do (progn 
             (file-position s i)
             (let ((char (read-char s nil :eof)))
               (if (eq char :eof)
                   (problem "EOF at ~2d" i)
                   (setf (char storage i) char)))))
  (unless (string= storage expected)
    (problem "Wrong result (got ~s instead of ~s)"
             storage expected)))
</pre>


</li>
</ul>
<ul>
<li id="sec-3-6-1-5">pattern-file-position-backward-with-reads<br/>

<p>
Like pattern-file-position-backward, but each file-position is followed by reading up to the end of the string again. This
test is to ensure that file-position produces correct results for <b>all</b> subsequent read-chars &ndash; not just the next one.
</p>



<pre class="example">(defpattern pattern-file-position-backward-with-reads (s expected)
  (loop for i from (1- (length expected)) downto 0
        do (fill storage #\_)
        do (file-position s i)
        do (loop for j from i upto (1- (length expected))
                   as char = (read-char s nil :eof)
                   if (eq char :eof)
                   do (problem "EOF reading from ~2d at ~2d: ~s"
                               i j storage)
                   do (setf (char storage j) char))
        if (not (string= (subseq storage i) (subseq expected i)))
        do (problem "Wrong result (reading from ~2d got ~s instead of ~s)"
                    i storage expected)))

</pre>


</li>
</ul>
<ul>
<li id="sec-3-6-1-6">pattern-read-sequences<br/>

<p>
Uses read-sequence on every valid combination of (start, end).  Ensures every read-sequence no matter
where it starts or where it ends produces the correct result.
</p>



<pre class="example">(defpattern pattern-read-sequences (s expected)
  (loop for start from 0 upto (1- (length expected))
        do (loop for end from start upto (1- (length expected))
                 do (file-position s start)
                 do (fill storage #\_)
                 do (read-sequence storage s :start start :end end)
                 if (not (string= (subseq storage start end)
                                  (subseq expected start end)))
                 do (problem "Sequence (~2d, ~2d) got ~a instead of ~s"
                             start end storage expected))))
</pre>


</li>
</ul>
</div>

</div>

<div id="outline-container-3-6-2" class="outline-4">
<h4 id="sec-3-6-2"><span class="section-number-4">3.6.2</span> Running Tests</h4>
<div class="outline-text-4" id="text-3-6-2">


<p>
The bulk of the test code just has to do with collecting results and making pretty output.
</p>



<pre class="example">(defstruct results
  (tests 0)
  (failures nil))
(defun results-failure-count (results)
  (length (results-failures results)))
(defun results-successes (results)
  (- (results-tests results)
     (results-failure-count results)))

(defun runtest (fun results)
  (let* ((success t)
         (output (with-output-to-string (*standard-output*)
                   (setf success (funcall fun)))))
    (make-results
     :tests (1+ (results-tests results))
     :failures (if success
                   (results-failures results)
                   (acons fun output (results-failures results))))))

(defun present-failures (results)
  (format t "~%CHANGED-STREAM FAILURES:~%")
  (loop for (fn . problems) in (results-failures results)
        do (format t "~%~a~a~%" fn problems)))
(defun present-results (results)
  (format t "~%CHANGED-STREAM TEST RESULTS:")
  (format t "~%     Tests: ~a~%   Success: ~a~%  Failures: ~a" 
          (results-tests results)
          (results-successes results)
          (results-failure-count results))
  (when (results-failures results)
    (present-failures results)))

(defun run-tests ()
  (format t "~%RUNNING CHANGED-STREAM TESTS...")
  (present-results 
   (reduce #'(lambda (test results) (runtest test results))
           *all-tests* :from-end t :initial-value (make-results))))     
</pre>


</div>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Tests</h2>
<div class="outline-text-2" id="text-4">


<p>
This package is tested by changing the string '01234567890ABCDEF' in a 
known way and then verifying that the results are correct no matter
how it's read.
</p>
<p>
we test these reading patterns:
</p>
<dl>
<dt>Scanning</dt><dd>read-char the entire stream.

</dd>
<dt>Peeking</dt><dd>read-char the entire stream, but peek-char before reading.

</dd>
<dt>Seeking</dt><dd>file-position to the next character then read it, then next char, then &hellip;

</dd>
<dt>Backwards Seeking</dt><dd>File-position to the last character, then read it, then next-to-last, then &hellip;

</dd>
<dt>Backwards Seeking with Forward Scanning</dt><dd>File-position to the last character, then scan stream, then next-to-last, then &hellip;

</dd>
<dt>With read-sequence</dt><dd>For i from 0 to end, and j from i to end, use file-position and read-sequence to read the range i to j.
</dd>
</dl>



</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Deletion Tests</h3>
<div class="outline-text-3" id="text-4-1">


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="right" /><col class="right" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="right"><b>at</b></th><th scope="col" class="right"><b>delete</b></th><th scope="col" class="left"></th><th scope="col" class="left"><b>is</b></th><th scope="col" class="left"><b>Comments</b></th></tr>
</thead>
<tbody>
<tr><td class="right">0</td><td class="right">0</td><td class="left"></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left">No changes returns original stream.</td></tr>
</tbody>
<tbody>
<tr><td class="right">0</td><td class="right">1</td><td class="left"></td><td class="left"><code>123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">2</td><td class="left"></td><td class="left"><code>23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">3</td><td class="left"></td><td class="left"><code>3456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">8</td><td class="left"></td><td class="left"><code>89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">9</td><td class="left"></td><td class="left"><code>9ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">15</td><td class="left"></td><td class="left"><code>F</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">16</td><td class="left"></td><td class="left"></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">17</td><td class="left"></td><td class="left"></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">18</td><td class="left"></td><td class="left"></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">1</td><td class="right">1</td><td class="left"></td><td class="left"><code>023456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">2</td><td class="left"></td><td class="left"><code>03456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">3</td><td class="left"></td><td class="left"><code>0456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">7</td><td class="left"></td><td class="left"><code>089ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">13</td><td class="left"></td><td class="left"><code>0EF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">14</td><td class="left"></td><td class="left"><code>0F</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">15</td><td class="left"></td><td class="left"><code>0</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">16</td><td class="left"></td><td class="left"><code>0</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">17</td><td class="left"></td><td class="left"><code>0</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">2</td><td class="right">1</td><td class="left"></td><td class="left"><code>013456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="right">2</td><td class="left"></td><td class="left"><code>01456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="right">7</td><td class="left"></td><td class="left"><code>019ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="right">13</td><td class="left"></td><td class="left"><code>01F</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="right">14</td><td class="left"></td><td class="left"><code>01</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="right">15</td><td class="left"></td><td class="left"><code>01</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">8</td><td class="right">1</td><td class="left"></td><td class="left"><code>012345679ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">2</td><td class="left"></td><td class="left"><code>01234567ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">7</td><td class="left"></td><td class="left"><code>01234567F</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">8</td><td class="left"></td><td class="left"><code>01234567</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">9</td><td class="left"></td><td class="left"><code>01234567</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">14</td><td class="right">1</td><td class="left"></td><td class="left"><code>0123456789ABCDF</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="right">2</td><td class="left"></td><td class="left"><code>0123456789ABCD</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="right">3</td><td class="left"></td><td class="left"><code>0123456789ABCD</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">15</td><td class="right">1</td><td class="left"></td><td class="left"><code>0123456789ABCDE</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="right">2</td><td class="left"></td><td class="left"><code>0123456789ABCDE</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">16</td><td class="right">1</td><td class="left"></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="right">2</td><td class="left"></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">17</td><td class="right">1</td><td class="left"></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Insertion Tests</h3>
<div class="outline-text-3" id="text-4-2">


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="right" /><col class="left" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="right"><b>at</b></th><th scope="col" class="left"></th><th scope="col" class="left"><b>insert</b></th><th scope="col" class="left"><b>is</b></th><th scope="col" class="left"><b>Comments</b></th></tr>
</thead>
<tbody>
<tr><td class="right">0</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>x0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>xy0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>)!@#$%^&amp;*(abcdef0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>)!@#$%^&amp;*(abcdef+0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+-</code></td><td class="left"><code>)!@#$%^&amp;*(abcdef+-0123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">1</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0x123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>0xy123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>0)!@#$%^&amp;*(abcdef123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>0)!@#$%^&amp;*(abcdef+123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">2</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>01x23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>01xy23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>01)!@#$%^&amp;*(abcdef23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">2</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>01)!@#$%^&amp;*(abcdef+23456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">8</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>01234567x89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>01234567xy89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>01234567)!@#$%^&amp;*(abcdef89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>01234567)!@#$%^&amp;*(abcdef+89ABCDEF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">14</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0123456789ABCDxEF</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>0123456789ABCDxyEF</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>0123456789ABCD)!@#$%^&amp;*(abcdefEF</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>0123456789ABCD)!@#$%^&amp;*(abcdef+EF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">15</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0123456789ABCDExF</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>0123456789ABCDExyF</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>0123456789ABCDE)!@#$%^&amp;*(abcdefF</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>0123456789ABCDE)!@#$%^&amp;*(abcdef+F</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">16</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0123456789ABCDEFx</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="left"></td><td class="left"><code>xy</code></td><td class="left"><code>0123456789ABCDEFxy</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>0123456789ABCDEF)!@#$%^&amp;*(abcdef</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="left"></td><td class="left"><code>)!@#$%^&amp;*(abcdef+</code></td><td class="left"><code>0123456789ABCDEF)!@#$%^&amp;*(abcdef+</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">17</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">18</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">20</td><td class="left"></td><td class="left"><code>x</code></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Replacement Tests</h3>
<div class="outline-text-3" id="text-4-3">


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="right" /><col class="right" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="right"><b>at</b></th><th scope="col" class="right"><b>delete</b></th><th scope="col" class="left"><b>insert</b></th><th scope="col" class="left"><b>is</b></th><th scope="col" class="left"><b>Comments</b></th></tr>
</thead>
<tbody>
<tr><td class="right">0</td><td class="right">1</td><td class="left"><code>)</code></td><td class="left"><code>)123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">2</td><td class="left"><code>)!</code></td><td class="left"><code>)!23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">8</td><td class="left"><code>)!@#$%^&amp;</code></td><td class="left"><code>)!@#$%^&amp;89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">14</td><td class="left"><code>)!@#$%^&amp;*(abcd</code></td><td class="left"><code>)!@#$%^&amp;*(abcdEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">15</td><td class="left"><code>)!@#$%^&amp;*(abcde</code></td><td class="left"><code>)!@#$%^&amp;*(abcdeF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">16</td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">17</td><td class="left"><code>)!@#$%^&amp;*(abcdefg</code></td><td class="left"><code>)!@#$%^&amp;*(abcdefg</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">18</td><td class="left"><code>)!@#$%^&amp;*(abcdefgh</code></td><td class="left"><code>)!@#$%^&amp;*(abcdefgh</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">1</td><td class="right">1</td><td class="left"><code>!</code></td><td class="left"><code>0!23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">8</td><td class="left"><code>!@#$%^&amp;*</code></td><td class="left"><code>0!@#$%^&amp;*9ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">14</td><td class="left"><code>!@#$%^&amp;*(abcde</code></td><td class="left"><code>0!@#$%^&amp;*(abcdeF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">15</td><td class="left"><code>!@#$%^&amp;*(abcdef</code></td><td class="left"><code>0!@#$%^&amp;*(abcdef</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">16</td><td class="left"><code>!@#$%^&amp;*(abcdefg</code></td><td class="left"><code>0!@#$%^&amp;*(abcdefg</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">17</td><td class="left"><code>!@#$%^&amp;*(abcdefgh</code></td><td class="left"><code>0!@#$%^&amp;*(abcdefgh</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">8</td><td class="right">1</td><td class="left"><code>*</code></td><td class="left"><code>01234567*9ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">7</td><td class="left"><code>*(abcde</code></td><td class="left"><code>01234567*(abcdeF</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">8</td><td class="left"><code>*(abcdef</code></td><td class="left"><code>01234567*(abcdef</code></td><td class="left"></td></tr>
<tr><td class="right">8</td><td class="right">9</td><td class="left"><code>*(abcdefg</code></td><td class="left"><code>01234567*(abcdefg</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">14</td><td class="right">1</td><td class="left"><code>e</code></td><td class="left"><code>0123456789ABCDeF</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="right">2</td><td class="left"><code>ef</code></td><td class="left"><code>0123456789ABCDef</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="right">3</td><td class="left"><code>efg</code></td><td class="left"><code>0123456789ABCDefg</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">15</td><td class="right">1</td><td class="left"><code>f</code></td><td class="left"><code>0123456789ABCDEf</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="right">2</td><td class="left"><code>fg</code></td><td class="left"><code>0123456789ABCDEfg</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">16</td><td class="right">1</td><td class="left"><code>g</code></td><td class="left"><code>0123456789ABCDEFg</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="right">2</td><td class="left"><code>gh</code></td><td class="left"><code>0123456789ABCDEFgh</code></td><td class="left"></td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Replace+Delete Tests</h3>
<div class="outline-text-3" id="text-4-4">


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="right" /><col class="right" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="right"><b>at</b></th><th scope="col" class="right"><b>delete</b></th><th scope="col" class="left"><b>insert</b></th><th scope="col" class="left"><b>is</b></th><th scope="col" class="left"><b>Comments</b></th></tr>
</thead>
<tbody>
<tr><td class="right">0</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>)23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">4</td><td class="left"><code>)!</code></td><td class="left"><code>)!456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">8</td><td class="left"><code>)!@#</code></td><td class="left"><code>)!@#89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">15</td><td class="left"><code>)!</code></td><td class="left"><code>)!F</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">16</td><td class="left"><code>)!</code></td><td class="left"><code>)!</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">17</td><td class="left"><code>)!</code></td><td class="left"><code>)!</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">1</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>0)3456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">14</td><td class="left"><code>)</code></td><td class="left"><code>0)F</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">15</td><td class="left"><code>)</code></td><td class="left"><code>0)</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">16</td><td class="left"><code>)</code></td><td class="left"><code>0)</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">13</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>0123456789ABC)F</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>0123456789ABCD)</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>0123456789ABCDE)</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>0123456789ABCDEF)</code></td><td class="left"></td></tr>
<tr><td class="right">17</td><td class="right">2</td><td class="left"><code>)</code></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Replace+Insert Tests</h3>
<div class="outline-text-3" id="text-4-5">


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="right" /><col class="right" /><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="right"><b>at</b></th><th scope="col" class="right"><b>delete</b></th><th scope="col" class="left"><b>insert</b></th><th scope="col" class="left"><b>is</b></th><th scope="col" class="left"><b>Comments</b></th></tr>
</thead>
<tbody>
<tr><td class="right">0</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>)!123456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">2</td><td class="left"><code>)!@#</code></td><td class="left"><code>)!@#23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">4</td><td class="left"><code>)!@#$%^&amp;</code></td><td class="left"><code>)!@#$%^&amp;456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">8</td><td class="left"><code>)!@#$%^&amp;*(abcdef</code></td><td class="left"><code>)!@#$%^&amp;*(abcdef89ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">15</td><td class="left"><code>)!@#$%^&amp;*(abcdefxyz</code></td><td class="left"><code>)!@#$%^&amp;*(abcdefxyzF</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">16</td><td class="left"><code>)!@#$%^&amp;*(abcdefxyz</code></td><td class="left"><code>)!@#$%^&amp;*(abcdefxyz</code></td><td class="left"></td></tr>
<tr><td class="right">0</td><td class="right">17</td><td class="left"><code>)!@#$%^&amp;*(abcdefxyz</code></td><td class="left"><code>)!@#$%^&amp;*(abcdefxyz</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">1</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>0)!23456789ABCDEF</code></td><td class="left"></td></tr>
<tr><td class="right">1</td><td class="right">2</td><td class="left"><code>)!@#</code></td><td class="left"><code>0)!@#3456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
<tbody>
<tr><td class="right">13</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>0123456789ABC)!EF</code></td><td class="left"></td></tr>
<tr><td class="right">14</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>0123456789ABCD)!F</code></td><td class="left"></td></tr>
<tr><td class="right">15</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>0123456789ABCDE)!</code></td><td class="left"></td></tr>
<tr><td class="right">16</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>0123456789ABCDEF)!</code></td><td class="left"></td></tr>
<tr><td class="right">17</td><td class="right">1</td><td class="left"><code>)!</code></td><td class="left"><code>0123456789ABCDEF</code></td><td class="left"></td></tr>
</tbody>
</table>


</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> License</h2>
<div class="outline-text-2" id="text-5">


<p>
Changed-stream is distributed under <a href="http://opensource.org/licenses/lgpl-2.1.php">LGPL2</a> License. 
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> Changed-streams, like regular streams, aren't implicitly thread safe. But also ensure the underlying stream isn't being read concurrently.
</p>


<p class="footnote"><sup><a class="footnum" name="fn.2" href="#fnr.2">2</a></sup> you might need to (require 'asdf) before running this example
</p>


</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-12-17 08:26:33 MST</p>
<p class="author">Author: Warren Wilkinson</p>
<p class="creator">Org version 7.8.11 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
